WITH RECURSIVE tax AS (
                SELECT  id,
			name,
                    ARRAY[]::INTEGER[] AS ancestors,
                    ARRAY[]::character varying[] AS ancestor_names
                FROM    taxonomy_category as category
                WHERE   "parentId" IS NULL
                AND category.deleted = false

                UNION ALL

                SELECT  category.id,
			category.name,
                    tax.ancestors || category."parentId",
                    tax.ancestor_names || parent_category.name
                FROM    taxonomy_category as category
                    JOIN tax on category."parentId" = tax.id
                    JOIN taxonomy_category parent_category on category."parentId" = parent_category.id
                WHERE   category.deleted = false
                
            ),
           
 merch AS (
                SELECT  id,
			name,
                    ARRAY[]::INTEGER[] AS ancestors,
                    ARRAY[]::character varying[] AS ancestor_names
                FROM    merchandising_category as category
                WHERE   "parentId" IS NULL
                AND category.deleted = false
                 and category.visible = true

                UNION ALL

                SELECT  category.id,
			category.name,
                    merch.ancestors || category."parentId",
                    merch.ancestor_names || parent_category.name
                FROM    merchandising_category as category
                    JOIN merch on category."parentId" = merch.id
                    JOIN merchandising_category parent_category on category."parentId" = parent_category.id
                WHERE   category.deleted = false
			and category.visible = true		
            )

           

SELECT
  tprod."gtPartNumber" as "Gamut Part Number"
  , tprod."supplierSku" as "Grainger Part Number"
  , array_to_string(merch.ancestor_names || merch.name,' > ') as "Merchandising Terminal Node Path"
  , array_to_string(tax.ancestor_names || tax.name,' > ') as "tax_path"  
  , mprod."merchandisingCategoryId" AS "Merchandising Terminal Node ID"
  , tprod."categoryId" as "PIM Node ID"
  , mcoll.name as "Collection Name"
  , tprod.status as "Status"
  , tsales."displaySellUnitQty" as "Display Qty"
  , tsales."displaySellUom" as "Display UOM"

FROM taxonomy_product tprod

INNER JOIN tax
  ON tax.id = tprod."categoryId"
  -- AND (10006 = ANY(tax.ancestors)) --OR 8215 = ANY(tax.ancestors) OR 7739 = ANY(tax.ancestors))  -- *** ADD TOP LEVEL NODES HERE ***

LEFT JOIN taxonomy_product_sales_data tsales
  ON tsales."supplierProductId" = tprod."supplierProductId"
  	
LEFT JOIN  merchandising_product mprod
  ON tprod.id = mprod."taxonomyProductId"
  AND mprod.deleted = 'f'

INNER JOIN merch
  ON merch.id = mprod."merchandisingCategoryId"
  --AND (8575 = ANY(merch.ancestors)) --OR 8215 = ANY(merch.ancestors) OR 7739 = ANY(merch.ancestors))  -- *** ADD TOP LEVEL NODES HERE ***
  
INNER JOIN merchandising_category mcat
  ON mcat.id = mprod."merchandisingCategoryId"
  
INNER JOIN merchandising_collection_product mcollprod
  ON mcollprod."merchandisingProductId" = mprod.id
  
INNER JOIN merchandising_collection mcoll
  ON mcoll.id = mcollprod."collectionId"

WHERE
  tprod."gtPartNumber" IN ('854A666', '841X380', '714W834', '220K653', '101K205', '138A742', '876Z285', '622W295', '827W190', '176Z246', '294U520', '370R154', '127R609', '655X361', '415K423', '363W490', '968R841', '716K120', '523W469', '627X181', '534W625', '320A663', '219A200', '418Z120', '292X982', '763U305', '285U803', '248R219', '516W540', '476U182', '835U737', '943R653', '724W139', '982R134', '911R017', '867A097', '768Z236', '650A862', '553X534', '346Z754', '154W175', '989U449', '442U538', '162X178', '731A432', '728K726', '503K903', '771X613', '779Z353', '604A907', '321X735', '250K950', '233U644', '232W598', '268U417', '324K761', '532A541', '965A355', '936X791', '957X940', '882A259', '887R321', '868K658', '879A790', '902R913', '839K079', '814A783', '743Z995', '744R832', '697W491', '728U198', '720X012', '726R672', '679W612', '693W556', '628X999', '540X398', '578X775', '533K895', '502R711', '531A929', '473A187', '452W220', '482U128', '301Z023', '269X679', '285U292', '209Z903', '229R203', '233U269', '248U497', '227A540', '255Z862', '246K970', '180U159', '127W322', '115Z431', '872Z742', '796Z290', '142K772', '742K552', '988X084', '345R726', '100K447', '539R903', '116W826', '309K503', '669K054', '996W732', '993U006', '993A044', '986Z266', '974W863', '975X125', '964Z864', '962A124', '961A546', '942Z012', '937K956', '934A202', '915Z097', '912K930', '887R964', '878A498', '863U449', '859U645', '848R934', '846K407', '840A083', '816K604', '814A179', '809U555', '802Z593', '803W925', '803A295', '788X119', '789U096', '780X438', '778Z879', '769R085', '767W659', '769R317', '757K825', '733W704', '723U788', '719K131', '715W870', '701U195', '690U872', '687K453', '685A144', '685R970', '683R751', '675K373', '671X850', '660K734', '658R495', '638X486', '641A802', '619W254', '594X786', '588W491', '584X702', '573A801', '560W889', '550K847', '549K278', '543R315', '530Z884', '525K212', '526W147', '499W615', '497X545', '498A779', '498W335', '494X394', '494U368', '471K830', '459U615', '456U747', '456U634', '441W887', '438A452', '409U148', '407K004', '397A505', '387A957', '373K497', '371R602', '351A816', '344R235', '346A759', '339A009', '310U162', '310R729', '307Z051', '304A513', '299K803', '290W510', '288R784', '272X074', '265K458', '251K232', '246X468', '240X584', '233W237', '232K652', '197K864', '191U092', '186A696', '185R092', '179X080', '176R452', '172R521', '162W915', '161Z469', '147U680', '145U685', '145R830', '115K916', '271U308', '911K206', '797R740', '497X718', '150X165', '478W630', '178R053', '455W773', '377Z797', '999U979', '961Z248', '977Z551', '965K244', '985U015', '965K198', '826U003', '945K717', '836Z964', '784R202', '807R818', '949W795', '786U697', '951W794', '928K062', '834Z289', '896R105', '877K918', '902Z748', '850W718', '814U061', '884A077', '796Z147', '878U471', '867W366', '861Z740', '909U600', '921X015', '853Z941', '791X249', '870Z459', '836K970', '955W746', '789A780', '799Z924', '793U166', '827W440', '912X431', '794A918', '864R450', '786Z249', '743A495', '616A794', '726U537', '777R836', '611K039', '679K379', '667X511', '674U194', '619R660', '639W766', '729K007', '621K473', '735K026', '742Z679', '715R912', '781Z961', '693Z162', '627K690', '776U335', '616K499', '653Z571', '727Z052', '671Z482', '658X084', '662Z930', '775Z854', '701R866', '671Z599', '623U187', '725U455', '712W472', '694K971', '669Z119', '670K608', '759W162', '630W205', '588W374', '581Z918', '598W097', '473Z124', '466W976', '514K026', '588A703', '554Z762', '512A499', '461Z565', '549X325', '508W236', '540K336', '500Z034', '572Z908', '593W585', '596R539', '484X485', '610Z186', '573K386', '462R181', '514R945', '606A672', '486K638', '463X184', '593W752', '608X277', '585A490', '571U481', '527R428', '474Z869', '445K091', '526K276', '452X335', '537K328', '596W123', '548U805', '530A006', '523W116', '587Z513', '483X112', '411W398', '400R343', '282Z317', '435U793', '323U400', '297U297', '322W318', '306Z950', '414A826', '342A447', '354X726', '299K949', '332W092', '367Z703', '349Z668', '312X196', '377Z513', '384K118', '434Z524', '363K821', '331Z045', '402X298', '438W339', '403U002', '347R881', '434W663', '312K557', '312X659', '382R671', '381R847', '371R073', '289A013', '154W462', '148U789', '169Z586', '259R178', '184R080', '237Z179', '108X853', '190R786', '252Z389', '274A518', '219X404', '196R341', '194A875', '170R255', '251R604', '120Z789', '219W182', '157Z083', '235Z307', '130Z653', '178Z996', '136Z212', '123K051', '182Z941', '120R809', '276A388', '261A360', '165R487', '233K352', '199R641', '169K721', '156K451', '217R152', '207U132', '541A657', '483Z322', '470X817', '290X445', '651R592', '671Z531', '965A648', '923Z075', '759A591', '630Z259', '927Z400', '923W328', '710R760', '666U570', '748K699', '629A538', '955K966', '844X864', '826A677', '832K922', '940Z533', '842K081', '910A284', '721A364', '860R891', '760Z811', '981U582', '880A530', '763K607', '818Z326', '869Z374', '936X596', '767R748', '703A256', '700Z626', '692A010', '629U234', '882K822', '856Z085', '843R360', '702Z129', '917W661', '908A301', '924W597', '866R796', '707R852', '822Z743', '757U130', '967U153', '812R660', '876U955', '624K819', '680K137', '850U417', '855W940', '851Z133', '725K074', '898A968', '672X062', '752U907', '744A108', '775X267', '899K282', '761K558', '637Z625', '925R773', '994A445', '939X178', '634R798', '840Z991', '966Z263', '845W098', '833K398', '961X515', '663R758', '916A121', '249X366', '432X959', '213X478', '519X653', '154A694', '472A658', '496U494', '156Z609', '335X639', '321A662', '240R392', '462R532', '266A305', '587X348', '255W692', '231K983', '358Z819', '475U973', '467R814', '210Z839', '416X940', '122W294', '320Z049', '508W810', '202A731', '462Z892', '135X795', '151A966', '439A840', '349Z012', '581W752', '298Z565', '420X005', '381W073', '154K338', '248Z002', '322W650', '385R559', '327X063', '149K083', '353X876', '286X282', '377W661', '534W720', '243W656', '471A211', '282Z990', '293Z824', '486U630', '523U387', '603U193', '556R227', '561Z955', '525R992', '568R914', '603A748', '395A884', '532K441', '475X875', '282A389', '137U515', '368U080', '191A028', '533Z352', '521A673', '305X501', '107W147', '362U578', '544Z649', '264A083', '298U417', '337W507', '139W508', '515R074', '618K867', '826R362', '741U515', '717X423', '243X919', '785Z916', '784A617', '736W385', '683Z086', '663Z344', '585W172', '466K978', '211Z029', '206A068', '152Z988', '501A380', '871R288', '839X812', '844X499', '784Z377', '817A657', '712X183', '248U406', '703A817', '641K896', '804X152', '901X285', '752U149', '713W200', '679A550', '529Z033', '201Z247', '245A667', '110K368', '567K110', '925A422', '856K199', '805U859', '821Z375', '686X623', '713U854', '661W156', '734R174', '592X280', '640A167', '510Z839', '292W934', '318A810', '119Z974', '184Z676', '147A961', '741X715', '500K825', '468W368', '244R833', '271A301', '194K669', '160W314', '892W467', '835R858', '722X412', '655X969', '643W345', '412W134', '385X109', '218K584', '912X899', '561X717', '305A613', '248K059', '884A596', '496U090', '114Z680', '372A448', '381R374', '912R623', '773U497', '894A635', '518A308', '833R084', '739K227', '196Z101', '556X771', '371W564', '247R991', '174A670', '882A734', '944K660', '919K514', '800A996', '211K285', '685W495', '813X819', '610Z502', '365W401', '331A454', '188R523', '271Z458', '932U356', '883A718', '677U889', '577A151', '493K161', '280K108')
  
ORDER BY
  mprod."merchandisingCategoryId"
  , mcoll.name